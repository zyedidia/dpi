local archid = "aarch64"
local prefix = f"$archid-none-elf"

local knit = import("knit")
local druntime = knit.abs("libd")

local tools = {
    dc := $prefix-gdc
    as := $prefix-as
    ld := $prefix-ld
    cpp := $prefix-cpp
    objcopy := $prefix-objcopy
    objdump := $prefix-objdump
}

local cpu = "cortex-a72"
local arch = "armv8-a+crc"
local O = "s"
local link = "link.ld"

local flags = {
    dc := -O$O -g -nostartfiles -fno-druntime -Wa,-mcpu=$cpu -Wa,-march=$arch -I$druntime
    as := -mcpu=$cpu -march=$arch
    ld := -T $link --no-warn-rwx-segments
}

-- Use Ctrl-A x to quit qemu
local qemu := qemu-system-$archid
local board := raspi3b
local gdb := gdb-multiarch

local prog = cli.prog or "hello"
local kernel = include(f"$prog/build.knit").rules(tools, flags)
local allsrc = knit.rglob(".", "*.d")

return r{
$ all: $prog.bin $prog.list
$ %.o: %.d
    $(tools.dc) $(flags.dc) $input -c -o $output
$ %.o: %.s
    $(tools.cpp) $input | $(tools.as) $(flags.as) -c -o $output
$ %.bin: %.elf
    $(tools.objcopy) $input -O binary $output
$ %.list: %.elf
    $(tools.objdump) -D $input > $output
$ %.list: %.o
    $(tools.objdump) -D $input > $output

$ $prog/$prog.o:M: [$kernel][$prog]$prog.o
$ $prog.elf: $prog/$prog.o dstart.o start.o
    $(tools.ld) $(flags.ld) $input -o $output

$ qemu:VB: $prog.elf
    $qemu -M $board -nographic -kernel $input -serial null -serial mon:stdio -no-reboot
$ qemu-gdb:VB: $prog.elf
    $qemu -s -S -M $board -nographic -kernel $input -serial null -serial mon:stdio -no-reboot &
    $gdb -ex "file $input" -ex "target remote localhost:1234"

$ prog:VB: $prog.bin
    sudo piprog $input

$ format:VB:
    dfmt -i --brace_style=otbs $allsrc
}
